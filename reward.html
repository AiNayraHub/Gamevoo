<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gift Reward - Gamevoo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; }
        .reward-header { background: linear-gradient(135deg, #4f46e5, #9333ea); }
        .premium-shadow { box-shadow: 0 10px 25px -5px rgba(147, 51, 234, 0.1); }
    </style>
</head>
<body class="font-sans text-slate-900 pb-28">

    <div class="reward-header pb-28 pt-10 px-6 rounded-b-[50px] text-white text-center relative overflow-hidden">
        <div class="flex items-center justify-between mb-6 relative z-10">
            <button onclick="location.href='home.html'" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-md">
                <i class="fas fa-chevron-left text-sm"></i>
            </button>
            <h1 class="font-black uppercase tracking-widest text-sm">Gift Rewards</h1>
            <div class="w-10"></div>
        </div>
        <i class="fas fa-gift text-7xl opacity-20 absolute -right-4 bottom-10 rotate-12"></i>
        <h2 class="text-3xl font-black italic mb-2 relative z-10">Redeem Code</h2>
        <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Enter your secret code to get coins</p>
    </div>

    <div class="px-6 -mt-16 relative z-20">
        <div class="bg-white rounded-[35px] p-8 premium-shadow border border-indigo-50">
            <div class="space-y-5">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400">
                        <i class="fas fa-ticket-alt"></i>
                    </span>
                    <input id="gift-input" type="text" placeholder="ENTER GIFT CODE" 
                        class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-5 pl-12 pr-4 text-center font-black text-indigo-600 focus:border-indigo-500 outline-none transition-all uppercase placeholder:text-slate-300">
                </div>
                
                <button onclick="redeemGift()" id="redeem-btn" 
                    class="w-full bg-indigo-600 text-white py-5 rounded-[25px] font-black text-sm tracking-widest shadow-lg shadow-indigo-100 active:scale-95 transition-all">
                    CLAIM REWARD
                </button>
            </div>
        </div>

        <div class="mt-8 space-y-4">
            <div class="bg-indigo-50 rounded-2xl p-4 flex items-center gap-4">
                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm">
                    <i class="fas fa-info-circle"></i>
                </div>
                <p class="text-[10px] font-bold text-indigo-700 leading-tight uppercase">Ek code ko sirf ek hi baar use kiya ja sakta hai.</p>
            </div>
            
            <a href="https://t.me/+919559123316" target="_blank" class="block bg-white rounded-2xl p-4 text-center border border-slate-100">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Get New Codes on Telegram</p>
                <p class="text-xs font-bold text-blue-600 mt-1 italic">Join @GamevooSupport</p>
            </a>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-slate-100 p-5 flex justify-around items-center z-50 rounded-t-[30px]">
        <button onclick="location.href='home.html'" class="text-slate-300"><i class="fas fa-home text-xl"></i></button>
        <button onclick="location.href='wallet.html'" class="text-slate-300"><i class="fas fa-wallet text-xl"></i></button>
        <button onclick="location.href='reward.html'" class="text-indigo-600"><i class="fas fa-ticket-alt text-xl"></i></button>
        <button onclick="location.href='profile.html'" class="text-slate-300"><i class="fas fa-user text-xl"></i></button>
    </div>

    <script src="app.js"></script>
    <script>
        async function redeemGift() {
            const codeInput = document.getElementById('gift-input').value.trim().toUpperCase();
            const btn = document.getElementById('redeem-btn');

            if (!codeInput) return alert("Bhai, pehle code toh dalo!");
            if (!userId) return alert("Connection error! Refresh karein.");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Checking...';

            try {
                // 1. Check if user already used THIS specific code
                const { data: alreadyUsed, error: checkError } = await supabaseClient
                    .from('redeemed_codes')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('code_text', codeInput);

                if (alreadyUsed && alreadyUsed.length > 0) {
                    alert("Aap ye code pehle hi use kar chuke hain!");
                    resetBtn();
                    return;
                }

                // 2. Check if code exists in 'gift_codes' table
                const { data: codeData, error: codeError } = await supabaseClient
                    .from('gift_codes')
                    .select('*')
                    .eq('code', codeInput)
                    .single();

                if (codeError || !codeData) {
                    alert("Invalid Gift Code! Sahi code dalo.");
                    resetBtn();
                    return;
                }

                // 3. Add Coins to user account
                const rewardAmount = codeData.amount;
                const success = await addCoins(rewardAmount); // Ye function app.js mein hai

                if (success) {
                    // 4. Mark this code as used by this user in 'redeemed_codes'
                    await supabaseClient
                        .from('redeemed_codes')
                        .insert([{ user_id: userId, code_text: codeInput }]);

                    alert(`Mubarak ho! Aapko ${rewardAmount} coins mil gaye.`);
                    document.getElementById('gift-input').value = "";
                }

            } catch (err) {
                console.error(err);
                alert("Something went wrong!");
            }

            resetBtn();
        }

        function resetBtn() {
            const btn = document.getElementById('redeem-btn');
            btn.disabled = false;
            btn.innerHTML = 'CLAIM REWARD';
        }
    </script>
</body>
    </html>
    
